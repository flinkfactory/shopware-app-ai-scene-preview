(()=>{"use strict";var e={857:e=>{var t=function(e){var t;return!!e&&"object"==typeof e&&"[object RegExp]"!==(t=Object.prototype.toString.call(e))&&"[object Date]"!==t&&e.$$typeof!==s},s="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function o(e,t){return!1!==t.clone&&t.isMergeableObject(e)?a(Array.isArray(e)?[]:{},e,t):e}function n(e,t,s){return e.concat(t).map(function(e){return o(e,s)})}function r(e){return Object.keys(e).concat(Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter(function(t){return Object.propertyIsEnumerable.call(e,t)}):[])}function i(e,t){try{return t in e}catch(e){return!1}}function a(e,s,l){(l=l||{}).arrayMerge=l.arrayMerge||n,l.isMergeableObject=l.isMergeableObject||t,l.cloneUnlessOtherwiseSpecified=o;var c,h,d=Array.isArray(s);return d!==Array.isArray(e)?o(s,l):d?l.arrayMerge(e,s,l):(h={},(c=l).isMergeableObject(e)&&r(e).forEach(function(t){h[t]=o(e[t],c)}),r(s).forEach(function(t){(!i(e,t)||Object.hasOwnProperty.call(e,t)&&Object.propertyIsEnumerable.call(e,t))&&(i(e,t)&&c.isMergeableObject(s[t])?h[t]=(function(e,t){if(!t.customMerge)return a;var s=t.customMerge(e);return"function"==typeof s?s:a})(t,c)(e[t],s[t],c):h[t]=o(s[t],c))}),h)}a.all=function(e,t){if(!Array.isArray(e))throw Error("first argument should be an array");return e.reduce(function(e,s){return a(e,s,t)},{})},e.exports=a}},t={};function s(o){var n=t[o];if(void 0!==n)return n.exports;var r=t[o]={exports:{}};return e[o](r,r.exports,s),r.exports}(()=>{s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t}})(),(()=>{s.d=(e,t)=>{for(var o in t)s.o(t,o)&&!s.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})}})(),(()=>{s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})(),(()=>{var e=s(857),t=s.n(e);class o{static ucFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}static lcFirst(e){return e.charAt(0).toLowerCase()+e.slice(1)}static toDashCase(e){return e.replace(/([A-Z])/g,"-$1").replace(/^-/,"").toLowerCase()}static toLowerCamelCase(e,t){let s=o.toUpperCamelCase(e,t);return o.lcFirst(s)}static toUpperCamelCase(e,t){return t?e.split(t).map(e=>o.ucFirst(e.toLowerCase())).join(""):o.ucFirst(e.toLowerCase())}static parsePrimitive(e){try{return/^\d+(.|,)\d+$/.test(e)&&(e=e.replace(",",".")),JSON.parse(e)}catch(t){return e.toString()}}}class n{static isNode(e){return"object"==typeof e&&null!==e&&(e===document||e===window||e instanceof Node)}static hasAttribute(e,t){if(!n.isNode(e))throw Error("The element must be a valid HTML Node!");return"function"==typeof e.hasAttribute&&e.hasAttribute(t)}static getAttribute(e,t){let s=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(s&&!1===n.hasAttribute(e,t))throw Error('The required property "'.concat(t,'" does not exist!'));if("function"!=typeof e.getAttribute){if(s)throw Error("This node doesn't support the getAttribute function!");return}return e.getAttribute(t)}static getDataAttribute(e,t){let s=!(arguments.length>2)||void 0===arguments[2]||arguments[2],r=t.replace(/^data(|-)/,""),i=o.toLowerCamelCase(r,"-");if(!n.isNode(e)){if(s)throw Error("The passed node is not a valid HTML Node!");return}if(void 0===e.dataset){if(s)throw Error("This node doesn't support the dataset attribute!");return}let a=e.dataset[i];if(void 0===a){if(s)throw Error('The required data attribute "'.concat(t,'" does not exist on ').concat(e,"!"));return a}return o.parsePrimitive(a)}static querySelector(e,t){let s=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(s&&!n.isNode(e))throw Error("The parent node is not a valid HTML Node!");let o=e.querySelector(t)||!1;if(s&&!1===o)throw Error('The required element "'.concat(t,'" does not exist in parent node!'));return o}static querySelectorAll(e,t){let s=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(s&&!n.isNode(e))throw Error("The parent node is not a valid HTML Node!");let o=e.querySelectorAll(t);if(0===o.length&&(o=!1),s&&!1===o)throw Error('At least one item of "'.concat(t,'" must exist in parent node!'));return o}static getFocusableElements(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.body;return e.querySelectorAll('\n            input:not([tabindex^="-"]):not([disabled]):not([type="hidden"]),\n            select:not([tabindex^="-"]):not([disabled]),\n            textarea:not([tabindex^="-"]):not([disabled]),\n            button:not([tabindex^="-"]):not([disabled]),\n            a[href]:not([tabindex^="-"]):not([disabled]),\n            [tabindex]:not([tabindex^="-"]):not([disabled])\n        ')}static getFirstFocusableElement(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.body;return this.getFocusableElements(e)[0]}static getLastFocusableElement(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document,t=this.getFocusableElements(e);return t[t.length-1]}}class r{publish(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=new CustomEvent(e,{detail:t,cancelable:s});return this.el.dispatchEvent(o),o}subscribe(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=this,n=e.split("."),r=s.scope?t.bind(s.scope):t;if(s.once&&!0===s.once){let t=r;r=function(s){o.unsubscribe(e),t(s)}}return this.el.addEventListener(n[0],r),this.listeners.push({splitEventName:n,opts:s,cb:r}),!0}unsubscribe(e){let t=e.split(".");return this.listeners=this.listeners.reduce((e,s)=>([...s.splitEventName].sort().toString()===t.sort().toString()?this.el.removeEventListener(s.splitEventName[0],s.cb):e.push(s),e),[]),!0}reset(){return this.listeners.forEach(e=>{this.el.removeEventListener(e.splitEventName[0],e.cb)}),this.listeners=[],!0}get el(){return this._el}set el(e){this._el=e}get listeners(){return this._listeners}set listeners(e){this._listeners=e}constructor(e=document){this._el=e,e.$emitter=this,this._listeners=[]}}class i{init(){throw Error('The "init" method for the plugin "'.concat(this._pluginName,'" is not defined.'))}update(){}_init(){this._initialized||(this.init(),this._initialized=!0)}_update(){this._initialized&&this.update()}_mergeOptions(e){let s=o.toDashCase(this._pluginName),r=n.getDataAttribute(this.el,"data-".concat(s,"-config"),!1),i=n.getAttribute(this.el,"data-".concat(s,"-options"),!1),a=[this.constructor.options,this.options,e];r&&a.push(window.PluginConfigManager.get(this._pluginName,r));try{i&&a.push(JSON.parse(i))}catch(e){throw console.error(this.el),Error('The data attribute "data-'.concat(s,'-options" could not be parsed to json: ').concat(e.message))}return t().all(a.filter(e=>e instanceof Object&&!(e instanceof Array)).map(e=>e||{}))}_registerInstance(){window.PluginManager.getPluginInstancesFromElement(this.el).set(this._pluginName,this),window.PluginManager.getPlugin(this._pluginName,!1).get("instances").push(this)}_getPluginName(e){return e||(e=this.constructor.name),e}constructor(e,t={},s=!1){if(!n.isNode(e))throw Error("There is no valid element given.");this.el=e,this.$emitter=new r(this.el),this._pluginName=this._getPluginName(s),this.options=this._mergeOptions(t),this._initialized=!1,this._registerInstance(),this._init()}}class a{get(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"application/json",o=this._createPreparedRequest("GET",e,s);return this._sendRequest(o,null,t)}post(e,t,s){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"application/json";o=this._getContentType(t,o);let n=this._createPreparedRequest("POST",e,o);return this._sendRequest(n,t,s)}delete(e,t,s){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"application/json";o=this._getContentType(t,o);let n=this._createPreparedRequest("DELETE",e,o);return this._sendRequest(n,t,s)}patch(e,t,s){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"application/json";o=this._getContentType(t,o);let n=this._createPreparedRequest("PATCH",e,o);return this._sendRequest(n,t,s)}abort(){if(this._request)return this._request.abort()}setErrorHandlingInternal(e){this._errorHandlingInternal=e}_registerOnLoaded(e,t){t&&(!0===this._errorHandlingInternal?(e.addEventListener("load",()=>{t(e.responseText,e)}),e.addEventListener("abort",()=>{console.warn("the request to ".concat(e.responseURL," was aborted"))}),e.addEventListener("error",()=>{console.warn("the request to ".concat(e.responseURL," failed with status ").concat(e.status))}),e.addEventListener("timeout",()=>{console.warn("the request to ".concat(e.responseURL," timed out"))})):e.addEventListener("loadend",()=>{t(e.responseText,e)}))}_sendRequest(e,t,s){return this._registerOnLoaded(e,s),e.send(t),e}_getContentType(e,t){return e instanceof FormData&&(t=!1),t}_createPreparedRequest(e,t,s){return this._request=new XMLHttpRequest,this._request.open(e,t),this._request.setRequestHeader("X-Requested-With","XMLHttpRequest"),s&&this._request.setRequestHeader("Content-type",s),this._request}constructor(){this._request=null,this._errorHandlingInternal=!1}}class l extends i{init(){this.httpClient=new a,this.productId=this.options.productId,this.productName=this.options.productName,this.productImageUrl=this.options.productImage,this.maxGenerations=this.options.maxGenerations,this.debugMode=this.options.debugMode,this.generationsRemainingCount=this.maxGenerations,this.sceneImage=null,this.sceneImageFile=null,this.isTouchDragging=!1,this.touchGhostPosition=null,this.debugData=null,this.jwtToken=null,this.tokenStorageKey="flink_ai_scene_preview_token",this.tokenExpirationKey="flink_ai_scene_preview_token_exp",this.loadingMessages=["Analyzing your product...","Surveying the scene...","Describing placement location with AI...","Crafting the perfect composition prompt...","Generating photorealistic options...","Assembling the final scene..."],this.currentLoadingMessage=0,this._registerEvents(),this._getElements(),this._checkSessionStatus()}_registerEvents(){this.el.addEventListener("click",this._openModal.bind(this)),document.addEventListener("hidden.bs.modal",this._onModalHidden.bind(this)),document.addEventListener("change",e=>{e.target.matches(this.options.sceneInputSelector)&&this._handleSceneImageUpload(e.target.files[0])}),document.addEventListener("click",e=>{e.target.matches(this.options.changeSceneSelector)&&this._resetSceneUpload()}),document.addEventListener("click",e=>{e.target.matches(this.options.debugButtonSelector)&&this._showDebugModal()}),document.addEventListener("dragstart",this._handleDragStart.bind(this)),document.addEventListener("dragover",this._handleDragOver.bind(this)),document.addEventListener("drop",this._handleDrop.bind(this)),document.addEventListener("click",this._handleSceneClick.bind(this)),document.addEventListener("touchstart",this._handleTouchStart.bind(this)),document.addEventListener("touchmove",this._handleTouchMove.bind(this)),document.addEventListener("touchend",this._handleTouchEnd.bind(this))}_getElements(){this.modal=document.querySelector(this.options.modalSelector),this.debugModal=document.querySelector(this.options.debugModalSelector),this.sceneUpload=document.querySelector(this.options.sceneUploadSelector),this.scenePreview=document.querySelector(this.options.scenePreviewSelector),this.sceneInput=document.querySelector(this.options.sceneInputSelector),this.sceneImage=document.querySelector(this.options.sceneImageSelector),this.sceneDropzone=document.querySelector(this.options.sceneDropzoneSelector),this.productDisplay=document.querySelector(this.options.productDisplaySelector),this.productImageElement=document.querySelector(this.options.productImageSelector),this.productNameElement=document.querySelector(this.options.productNameSelector),this.placementOrb=document.querySelector(this.options.placementOrbSelector),this.loadingOverlay=document.querySelector(this.options.loadingOverlaySelector),this.loadingMessage=document.querySelector(this.options.loadingMessageSelector),this.errorMessage=document.querySelector(this.options.errorMessageSelector),this.errorText=document.querySelector(this.options.errorTextSelector),this.generationsRemaining=document.querySelector(this.options.generationsRemainingSelector),this.debugButton=document.querySelector(this.options.debugButtonSelector),this.touchGhost=document.querySelector(this.options.touchGhostSelector),this.debugImage=document.querySelector(this.options.debugImageSelector),this.debugPrompt=document.querySelector(this.options.debugPromptSelector)}_openModal(){this.productImageElement.src=this.productImageUrl,this.productImageElement.alt=this.productName,this.productNameElement.textContent=this.productName,new bootstrap.Modal(this.modal).show(),this._updateGenerationCounter()}_onModalHidden(e){e.target===this.modal&&this._resetModal()}_resetModal(){this._resetSceneUpload(),this._hideError(),this._hideLoadingOverlay(),this._hidePlacementOrb(),this.debugData=null,this._hideDebugButton()}_resetSceneUpload(){this.sceneUpload.classList.remove("d-none"),this.scenePreview.classList.add("d-none"),this.sceneInput.value="",this.sceneImageFile=null,this._hidePlacementOrb(),this._hideLoadingOverlay()}async _handleSceneImageUpload(e){if(!e||!e.type.startsWith("image/")){this._showError("Please select a valid image file.");return}try{let t=await this._fileToDataUrl(e);this.sceneImage.src=t,this.sceneImageFile=e,this.sceneUpload.classList.add("d-none"),this.scenePreview.classList.remove("d-none"),this._hideError()}catch(e){this._showError("Failed to load image: "+e.message)}}_handleDragStart(e){this._isProductDraggable(e.target)&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setDragImage(this._createTransparentImage(),0,0))}_handleDragOver(e){this._isDropZone(e.target)&&(e.preventDefault(),e.dataTransfer.dropEffect="move")}_handleDrop(e){if(!this._isDropZone(e.target))return;e.preventDefault();let t=this._calculateDropPosition(e);t&&this._generateComposite(t)}_handleSceneClick(e){if(!this._isDropZone(e.target))return;if(this.generationsRemainingCount<=0){this._showError("Generation limit reached for this session.");return}let t=this._calculateDropPosition(e);t&&this._generateComposite(t)}_handleTouchStart(e){if(!this._isProductDraggable(e.target))return;e.preventDefault(),this.isTouchDragging=!0;let t=e.touches[0];this.touchGhostPosition={x:t.clientX,y:t.clientY},this._showTouchGhost(),document.body.style.overflow="hidden"}_handleTouchMove(e){if(!this.isTouchDragging)return;e.preventDefault();let t=e.touches[0];this.touchGhostPosition={x:t.clientX,y:t.clientY},this._updateTouchGhost();let s=document.elementFromPoint(t.clientX,t.clientY);if(this._isDropZone(s)){let e=this.sceneDropzone.getBoundingClientRect(),s={x:t.clientX-e.left,y:t.clientY-e.top};this._showPlacementOrb(s)}else this._hidePlacementOrb()}_handleTouchEnd(e){if(!this.isTouchDragging)return;let t=e.changedTouches[0],s=document.elementFromPoint(t.clientX,t.clientY);if(this._isDropZone(s)){let e=this._calculateTouchDropPosition(t);e&&this._generateComposite(e)}this._endTouchDrag()}_endTouchDrag(){this.isTouchDragging=!1,this.touchGhostPosition=null,this._hideTouchGhost(),this._hidePlacementOrb(),document.body.style.overflow="auto"}async _generateComposite(e){if(this.generationsRemainingCount<=0){this._showError("Generation limit reached for this session.");return}if(!this.sceneImageFile){this._showError("Please upload a scene image first.");return}try{let t;console.log("Starting generation process..."),this._showLoadingOverlay(),this._showPlacementOrb(e),this._startLoadingMessages(),console.log("Converting scene image to data URL...");let s=await this._fileToDataUrl(this.sceneImageFile);console.log("Scene data URL created, length:",s.length),console.log("Creating request data for app server...");try{let e=await fetch(this.productImageUrl),s=await e.blob();t=await this._fileToDataUrl(s)}catch(e){console.warn("Could not fetch product image, using URL:",e),t=this.productImageUrl}let o={productId:this.productId,sceneImage:s,dropPosition:{xPercent:e.xPercent,yPercent:e.yPercent},productName:this.productName,productImage:t};console.log("Request data created for app server, productId:",this.productId),console.log("Making authenticated HTTP request to:",this.options.generateUrl);let n=await this._makeAuthenticatedRequest(this.options.generateUrl,"POST",o);console.log("Promise resolved with success:",n.success),this._stopLoadingMessages(),this._hideLoadingOverlay(),this._hidePlacementOrb(),n.success?(console.log("Generation successful, updating UI..."),this.sceneImage.src=n.data.finalImage,this.generationsRemainingCount=n.sessionStatus.remaining,this._updateGenerationCounter(),this.debugMode&&n.data.debugImage&&(this.debugData={image:n.data.debugImage,prompt:n.data.prompt},this._showDebugButton()),this._hideError()):(console.log("Generation failed with error:",n.error),this._showError(n.error||"Server returned failure status."),n.sessionStatus&&(this.generationsRemainingCount=n.sessionStatus.remaining,this._updateGenerationCounter()))}catch(e){console.error("Exception in generation process:",e),this._stopLoadingMessages(),this._hideLoadingOverlay(),this._hidePlacementOrb(),this._showError("JavaScript error during generation: "+e.message)}}async _checkSessionStatus(){try{console.log("Checking session status with authenticated request...");let e=await this._makeAuthenticatedRequest(this.options.sessionStatusUrl,"GET");e.success&&(this.generationsRemainingCount=e.data.remaining,this._updateGenerationCounter(),console.log("Session status updated, remaining:",e.data.remaining))}catch(e){console.warn("Could not check session status:",e)}}_calculateDropPosition(e){let t,s;let o=this.sceneDropzone.getBoundingClientRect(),n=this.sceneImage;if(!n.naturalWidth||!n.naturalHeight)return null;let r=n.naturalWidth/n.naturalHeight;r>o.width/o.height?(t=o.width,s=o.width/r):(s=o.height,t=o.height*r);let i=(o.width-t)/2,a=(o.height-s)/2,l=e.clientX-o.left,c=e.clientY-o.top,h=l-i,d=c-a;return h<0||h>t||d<0||d>s?null:{x:l,y:c,xPercent:h/t*100,yPercent:d/s*100}}_calculateTouchDropPosition(e){this.sceneDropzone.getBoundingClientRect();let t={clientX:e.clientX,clientY:e.clientY};return this._calculateDropPosition(t)}_showPlacementOrb(e){this.placementOrb.style.left=e.x+"px",this.placementOrb.style.top=e.y+"px",this.placementOrb.classList.remove("d-none")}_hidePlacementOrb(){this.placementOrb.classList.add("d-none")}_showLoadingOverlay(){this.loadingOverlay.classList.remove("d-none")}_hideLoadingOverlay(){this.loadingOverlay.classList.add("d-none")}_startLoadingMessages(){this.currentLoadingMessage=0,this.loadingMessage.textContent=this.loadingMessages[0],this.loadingInterval=setInterval(()=>{this.currentLoadingMessage=(this.currentLoadingMessage+1)%this.loadingMessages.length,this.loadingMessage.textContent=this.loadingMessages[this.currentLoadingMessage]},3e3)}_stopLoadingMessages(){this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null)}_showError(e){this.errorText.textContent=e,this.errorMessage.classList.remove("d-none")}_hideError(){this.errorMessage.classList.add("d-none")}_updateGenerationCounter(){this.generationsRemaining.parentElement.classList.remove("d-none"),this.generationsRemaining.textContent=this.generationsRemainingCount,this.generationsRemainingCount<=0&&(this.generationsRemaining.parentElement.classList.remove("alert-info"),this.generationsRemaining.parentElement.classList.add("alert-warning")),this.generationsRemainingCount>5&&this.generationsRemaining.parentElement.classList.add("d-none")}_showDebugButton(){this.debugButton&&this.debugButton.classList.remove("d-none")}_hideDebugButton(){this.debugButton&&this.debugButton.classList.add("d-none")}_showDebugModal(){this.debugData&&(this.debugImage.src=this.debugData.image,this.debugPrompt.textContent=this.debugData.prompt,new bootstrap.Modal(this.debugModal).show())}_showTouchGhost(){this.touchGhost.querySelector(".touch-ghost-image").src=this.productImageUrl,this.touchGhost.classList.remove("d-none"),this._updateTouchGhost()}_hideTouchGhost(){this.touchGhost.classList.add("d-none")}_updateTouchGhost(){this.touchGhostPosition&&(this.touchGhost.style.left=this.touchGhostPosition.x-25+"px",this.touchGhost.style.top=this.touchGhostPosition.y-25+"px")}_isProductDraggable(e){return null!==e.closest(this.options.productDisplaySelector)}_isDropZone(e){return e&&(e.matches(this.options.sceneDropzoneSelector)||null!==e.closest(this.options.sceneDropzoneSelector))}_fileToDataUrl(e){return new Promise((t,s)=>{let o=new FileReader;o.onload=()=>t(o.result),o.onerror=s,o.readAsDataURL(e)})}_createTransparentImage(){let e=new Image;return e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",e}async _ensureValidToken(){if(this._isTokenValid())return this.jwtToken;try{console.log("Requesting new JWT token from Shopware...");let e=await this._requestNewToken();return this._storeToken(e),e}catch(e){throw console.error("Failed to obtain JWT token:",e),Error("Authentication failed: "+e.message)}}_isTokenValid(){let e=sessionStorage.getItem(this.tokenStorageKey),t=sessionStorage.getItem(this.tokenExpirationKey);if(!e||!t)return!1;let s=parseInt(t);return Math.floor(Date.now()/1e3)>=s-60?(console.log("Token expired or about to expire, need to refresh"),!1):(this.jwtToken=e,!0)}async _requestNewToken(){return new Promise((e,t)=>{this.httpClient.post(this.options.tokenUrl,JSON.stringify({}),(s,o)=>{if(console.log("Token request response status:",o.status),o.status>=200&&o.status<300)try{let o=JSON.parse(s);o.token?(console.log("Successfully obtained JWT token"),e(o.token)):t(Error("No token in response"))}catch(e){console.error("Error parsing token response:",e),t(Error("Failed to parse token response: "+e.message))}else{console.error("Token request failed with status:",o.status);try{var n,r;let e=JSON.parse(s);t(Error(((r=e.errors)===null||void 0===r?void 0:(n=r[0])===null||void 0===n?void 0:n.detail)||"HTTP ".concat(o.status," error")))}catch(e){t(Error("HTTP ".concat(o.status,": ").concat(s)))}}},"application/json")})}_storeToken(e){try{let t=JSON.parse(atob(e.split(".")[1])).exp;sessionStorage.setItem(this.tokenStorageKey,e),sessionStorage.setItem(this.tokenExpirationKey,t.toString()),this.jwtToken=e,console.log("Token stored successfully, expires at:",new Date(1e3*t))}catch(e){throw console.error("Failed to decode token:",e),Error("Invalid token format")}}async _makeAuthenticatedRequest(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"GET",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;try{let n=await this._ensureValidToken();return new Promise((r,i)=>{if(console.log("Making authenticated request to:",e,"attempt:",o+1),"GET"===t)this.httpClient.get(e,(e,t)=>{this._handleAuthenticatedResponse(e,t,r,i)},"application/json");else if("POST"===t){let t=new XMLHttpRequest;t.open("POST",e),t.setRequestHeader("Content-Type","application/json"),t.setRequestHeader("Authorization","Bearer ".concat(n)),t.addEventListener("loadend",()=>{this._handleAuthenticatedResponse(t.responseText,t,r,i)}),t.send(s?JSON.stringify(s):null)}})}catch(n){if(0===o&&n.message.includes("Authentication failed"))return console.log("Authentication failed, retrying with fresh token..."),this._clearStoredToken(),this._makeAuthenticatedRequest(e,t,s,o+1);throw n}}_clearStoredToken(){sessionStorage.removeItem(this.tokenStorageKey),sessionStorage.removeItem(this.tokenExpirationKey),this.jwtToken=null}_handleAuthenticatedResponse(e,t,s,o){if(console.log("Authenticated request response status:",t.status),console.log("Response text length:",e?e.length:0),t.status>=200&&t.status<300)try{let t=JSON.parse(e);console.log("Successfully parsed authenticated response, success:",t.success),s(t)}catch(e){console.error("Error parsing authenticated response:",e),o(Error("Failed to parse server response: "+e.message))}else if(401===t.status)console.log("Received 401, clearing stored token"),this._clearStoredToken(),o(Error("Authentication failed - token expired"));else{console.error("HTTP error status:",t.status);try{let s=JSON.parse(e);o(Error(s.error||"HTTP ".concat(t.status," error")))}catch(s){o(Error("HTTP ".concat(t.status,": ").concat(e)))}}}}l.options={tokenUrl:"/store-api/app-system/FlinkAiScenePreviewApp/generate-token",generateUrl:"http://localhost:8083/api/ai-scene/generate",sessionStatusUrl:"http://localhost:8083/api/ai-scene/session-status",modalSelector:"[data-ai-scene-preview-modal]",debugModalSelector:"[data-ai-scene-debug-modal]",sceneUploadSelector:"[data-scene-upload]",scenePreviewSelector:"[data-scene-preview]",sceneInputSelector:"[data-scene-input]",sceneImageSelector:"[data-scene-image]",sceneDropzoneSelector:"[data-scene-dropzone]",productDisplaySelector:"[data-product-display]",productImageSelector:"[data-product-image]",productNameSelector:"[data-product-name]",placementOrbSelector:"[data-placement-orb]",loadingOverlaySelector:"[data-loading-overlay]",loadingMessageSelector:"[data-loading-message]",errorMessageSelector:"[data-error-message]",errorTextSelector:"[data-error-text]",generationsRemainingSelector:"[data-generations-remaining]",changeSceneSelector:"[data-change-scene]",debugButtonSelector:"[data-debug-button]",touchGhostSelector:"[data-touch-ghost]",debugImageSelector:"[data-debug-image]",debugPromptSelector:"[data-debug-prompt]"},window.PluginManager.register("AiScenePreview",l,"[data-ai-scene-preview-trigger]")})()})();