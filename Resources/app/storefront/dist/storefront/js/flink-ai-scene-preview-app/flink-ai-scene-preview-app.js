(()=>{"use strict";var e={857:e=>{var t=function(e){var t;return!!e&&"object"==typeof e&&"[object RegExp]"!==(t=Object.prototype.toString.call(e))&&"[object Date]"!==t&&e.$$typeof!==s},s="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function o(e,t){return!1!==t.clone&&t.isMergeableObject(e)?a(Array.isArray(e)?[]:{},e,t):e}function i(e,t,s){return e.concat(t).map(function(e){return o(e,s)})}function n(e){return Object.keys(e).concat(Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter(function(t){return Object.propertyIsEnumerable.call(e,t)}):[])}function r(e,t){try{return t in e}catch(e){return!1}}function a(e,s,l){(l=l||{}).arrayMerge=l.arrayMerge||i,l.isMergeableObject=l.isMergeableObject||t,l.cloneUnlessOtherwiseSpecified=o;var c,h,d=Array.isArray(s);return d!==Array.isArray(e)?o(s,l):d?l.arrayMerge(e,s,l):(h={},(c=l).isMergeableObject(e)&&n(e).forEach(function(t){h[t]=o(e[t],c)}),n(s).forEach(function(t){(!r(e,t)||Object.hasOwnProperty.call(e,t)&&Object.propertyIsEnumerable.call(e,t))&&(r(e,t)&&c.isMergeableObject(s[t])?h[t]=(function(e,t){if(!t.customMerge)return a;var s=t.customMerge(e);return"function"==typeof s?s:a})(t,c)(e[t],s[t],c):h[t]=o(s[t],c))}),h)}a.all=function(e,t){if(!Array.isArray(e))throw Error("first argument should be an array");return e.reduce(function(e,s){return a(e,s,t)},{})},e.exports=a}},t={};function s(o){var i=t[o];if(void 0!==i)return i.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,s),n.exports}(()=>{s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t}})(),(()=>{s.d=(e,t)=>{for(var o in t)s.o(t,o)&&!s.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})}})(),(()=>{s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})(),(()=>{var e=s(857),t=s.n(e);class o{static ucFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}static lcFirst(e){return e.charAt(0).toLowerCase()+e.slice(1)}static toDashCase(e){return e.replace(/([A-Z])/g,"-$1").replace(/^-/,"").toLowerCase()}static toLowerCamelCase(e,t){let s=o.toUpperCamelCase(e,t);return o.lcFirst(s)}static toUpperCamelCase(e,t){return t?e.split(t).map(e=>o.ucFirst(e.toLowerCase())).join(""):o.ucFirst(e.toLowerCase())}static parsePrimitive(e){try{return/^\d+(.|,)\d+$/.test(e)&&(e=e.replace(",",".")),JSON.parse(e)}catch(t){return e.toString()}}}class i{static isNode(e){return"object"==typeof e&&null!==e&&(e===document||e===window||e instanceof Node)}static hasAttribute(e,t){if(!i.isNode(e))throw Error("The element must be a valid HTML Node!");return"function"==typeof e.hasAttribute&&e.hasAttribute(t)}static getAttribute(e,t){let s=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(s&&!1===i.hasAttribute(e,t))throw Error('The required property "'.concat(t,'" does not exist!'));if("function"!=typeof e.getAttribute){if(s)throw Error("This node doesn't support the getAttribute function!");return}return e.getAttribute(t)}static getDataAttribute(e,t){let s=!(arguments.length>2)||void 0===arguments[2]||arguments[2],n=t.replace(/^data(|-)/,""),r=o.toLowerCamelCase(n,"-");if(!i.isNode(e)){if(s)throw Error("The passed node is not a valid HTML Node!");return}if(void 0===e.dataset){if(s)throw Error("This node doesn't support the dataset attribute!");return}let a=e.dataset[r];if(void 0===a){if(s)throw Error('The required data attribute "'.concat(t,'" does not exist on ').concat(e,"!"));return a}return o.parsePrimitive(a)}static querySelector(e,t){let s=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(s&&!i.isNode(e))throw Error("The parent node is not a valid HTML Node!");let o=e.querySelector(t)||!1;if(s&&!1===o)throw Error('The required element "'.concat(t,'" does not exist in parent node!'));return o}static querySelectorAll(e,t){let s=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(s&&!i.isNode(e))throw Error("The parent node is not a valid HTML Node!");let o=e.querySelectorAll(t);if(0===o.length&&(o=!1),s&&!1===o)throw Error('At least one item of "'.concat(t,'" must exist in parent node!'));return o}static getFocusableElements(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.body;return e.querySelectorAll('\n            input:not([tabindex^="-"]):not([disabled]):not([type="hidden"]),\n            select:not([tabindex^="-"]):not([disabled]),\n            textarea:not([tabindex^="-"]):not([disabled]),\n            button:not([tabindex^="-"]):not([disabled]),\n            a[href]:not([tabindex^="-"]):not([disabled]),\n            [tabindex]:not([tabindex^="-"]):not([disabled])\n        ')}static getFirstFocusableElement(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.body;return this.getFocusableElements(e)[0]}static getLastFocusableElement(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document,t=this.getFocusableElements(e);return t[t.length-1]}}class n{publish(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=new CustomEvent(e,{detail:t,cancelable:s});return this.el.dispatchEvent(o),o}subscribe(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=this,i=e.split("."),n=s.scope?t.bind(s.scope):t;if(s.once&&!0===s.once){let t=n;n=function(s){o.unsubscribe(e),t(s)}}return this.el.addEventListener(i[0],n),this.listeners.push({splitEventName:i,opts:s,cb:n}),!0}unsubscribe(e){let t=e.split(".");return this.listeners=this.listeners.reduce((e,s)=>([...s.splitEventName].sort().toString()===t.sort().toString()?this.el.removeEventListener(s.splitEventName[0],s.cb):e.push(s),e),[]),!0}reset(){return this.listeners.forEach(e=>{this.el.removeEventListener(e.splitEventName[0],e.cb)}),this.listeners=[],!0}get el(){return this._el}set el(e){this._el=e}get listeners(){return this._listeners}set listeners(e){this._listeners=e}constructor(e=document){this._el=e,e.$emitter=this,this._listeners=[]}}class r{init(){throw Error('The "init" method for the plugin "'.concat(this._pluginName,'" is not defined.'))}update(){}_init(){this._initialized||(this.init(),this._initialized=!0)}_update(){this._initialized&&this.update()}_mergeOptions(e){let s=o.toDashCase(this._pluginName),n=i.getDataAttribute(this.el,"data-".concat(s,"-config"),!1),r=i.getAttribute(this.el,"data-".concat(s,"-options"),!1),a=[this.constructor.options,this.options,e];n&&a.push(window.PluginConfigManager.get(this._pluginName,n));try{r&&a.push(JSON.parse(r))}catch(e){throw console.error(this.el),Error('The data attribute "data-'.concat(s,'-options" could not be parsed to json: ').concat(e.message))}return t().all(a.filter(e=>e instanceof Object&&!(e instanceof Array)).map(e=>e||{}))}_registerInstance(){window.PluginManager.getPluginInstancesFromElement(this.el).set(this._pluginName,this),window.PluginManager.getPlugin(this._pluginName,!1).get("instances").push(this)}_getPluginName(e){return e||(e=this.constructor.name),e}constructor(e,t={},s=!1){if(!i.isNode(e))throw Error("There is no valid element given.");this.el=e,this.$emitter=new n(this.el),this._pluginName=this._getPluginName(s),this.options=this._mergeOptions(t),this._initialized=!1,this._registerInstance(),this._init()}}class a{setItem(e,t){return this._storage[e]=t}getItem(e){return Object.prototype.hasOwnProperty.call(this._storage,e)?this._storage[e]:null}removeItem(e){return delete this._storage[e]}key(e){return Object.values(this._storage)[e]||null}clear(){return this._storage={}}constructor(){this._storage={}}}class l{get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.method="GET",this.request(e,t)}post(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.method="POST",this.request(e,t)}patch(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.method="PATCH",this.request(e,t)}delete(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.method="DELETE",this.request(e,t)}reset(){this.storage.removeItem(this.getStorageKey())}getStorageKey(){return"app-system.".concat(this.name)}async getHeaders(){let e=this.getStorageKey();if(!this.storage.getItem(e)){let t=await this.fetchHeaders();return this.storage.setItem(e,JSON.stringify(t)),t.headers}let t=JSON.parse(this.storage.getItem(e));return new Date(t.expires)<new Date?(this.storage.removeItem(e),await this.getHeaders()):t.headers}async fetchHeaders(){let e=window.router["frontend.app-system.generate-token"].replace("Placeholder",encodeURIComponent(this.name)),t=await fetch(e,{method:"POST"});if(!t.ok)throw Error("Error while fetching token, got status code: ".concat(t.status," with response ").concat(await t.text()));let s=await t.json();return{headers:{"shopware-app-token":s.token,"shopware-app-shop-id":s.shopId},expires:s.expires}}async request(e,t){return t.headers||(t.headers={}),t.headers={...t.headers,...await this.getHeaders()},fetch(e,t)}constructor(e){this.name=e;try{this.storage=window.sessionStorage}catch(e){this.storage=new a}}}let c="https://apps.flinkfactory.com/ai-scene-preview",h="flink-ai-scene-preview";class d extends r{init(){this.appClient=new l("FlinkAiScenePreviewApp"),this.productId=this.options.productId,this.productName=this.options.productName,this.productImageUrl=this.options.productImage,this.maxGenerations=this.options.maxGenerations,this.debugMode=this.options.debugMode,this.accessKey=this.options.accessKey,this.generationsRemainingCount=this.maxGenerations,this.sceneImage=null,this.sceneImageFile=null,this.isTouchDragging=!1,this.touchGhostPosition=null,this.debugData=null,this.translations={},this.isLoggedIn=!1,this.contextToken=null,this.hasCookieConsent=!1,this.loadingMessages=["Analyzing your product...","Surveying the scene...","Describing placement location with AI...","Crafting the perfect composition prompt...","Generating photorealistic options...","Assembling the final scene..."],this.currentLoadingMessage=0,this._registerEvents(),this._getElements(),this.isLoggedIn=!!this.modal&&"true"===this.modal.dataset.customerLoggedIn,this.hasCookieConsent=this._hasCookieConsent(),this._registerCookieConsentListener(),this._checkAutoOpenFromQuery(),this.isLoggedIn&&this._checkSessionStatus()}_registerEvents(){this.el.addEventListener("click",this._openModal.bind(this)),document.addEventListener("hidden.bs.modal",this._onModalHidden.bind(this)),document.addEventListener("change",e=>{e.target.matches(this.options.sceneInputSelector)&&this._handleSceneImageUpload(e.target.files[0])}),document.addEventListener("click",e=>{e.target.matches(this.options.changeSceneSelector)&&this._resetSceneUpload()}),document.addEventListener("click",e=>{e.target.matches(this.options.debugButtonSelector)&&this._showDebugModal()}),document.addEventListener("dragstart",this._handleDragStart.bind(this)),document.addEventListener("dragover",this._handleDragOver.bind(this)),document.addEventListener("drop",this._handleDrop.bind(this)),document.addEventListener("click",this._handleSceneClick.bind(this)),document.addEventListener("touchstart",this._handleTouchStart.bind(this)),document.addEventListener("touchmove",this._handleTouchMove.bind(this)),document.addEventListener("touchend",this._handleTouchEnd.bind(this))}_getElements(){this.modal=document.querySelector(this.options.modalSelector),this.debugModal=document.querySelector(this.options.debugModalSelector),this.sceneUpload=document.querySelector(this.options.sceneUploadSelector),this.scenePreview=document.querySelector(this.options.scenePreviewSelector),this.sceneInput=document.querySelector(this.options.sceneInputSelector),this.sceneImage=document.querySelector(this.options.sceneImageSelector),this.sceneDropzone=document.querySelector(this.options.sceneDropzoneSelector),this.productDisplay=document.querySelector(this.options.productDisplaySelector),this.productImageElement=document.querySelector(this.options.productImageSelector),this.productNameElement=document.querySelector(this.options.productNameSelector),this.placementOrb=document.querySelector(this.options.placementOrbSelector),this.loadingOverlay=document.querySelector(this.options.loadingOverlaySelector),this.loadingMessage=document.querySelector(this.options.loadingMessageSelector),this.errorMessage=document.querySelector(this.options.errorMessageSelector),this.errorText=document.querySelector(this.options.errorTextSelector),this.generationsCounter=document.querySelector(this.options.generationsCounterSelector),this.generationsAlert=document.querySelector(this.options.generationsAlertSelector),this.generationsRemaining=document.querySelector(this.options.generationsRemainingSelector),this.generationsMessage=document.querySelector(this.options.generationsMessageSelector),this.debugButton=document.querySelector(this.options.debugButtonSelector),this.touchGhost=document.querySelector(this.options.touchGhostSelector),this.debugImage=document.querySelector(this.options.debugImageSelector),this.debugPrompt=document.querySelector(this.options.debugPromptSelector),this._initializeTranslations()}_initializeTranslations(){if(this.translations={invalidImage:"Please select a valid image file.",loadFailed:"Failed to load image. Please try again.",noImage:"Please upload an image first.",sessionLimit:"Generation limit reached for this session.",generationFailed:"We had problems placing the product in your scene. Please try again. For best results, make sure that the scene image has enough free space available to place the product in a meaningful way.",generationException:"Something went wrong in the browser during generation. Please try again.",cookieRequired:"Please accept the AI scene preview cookie in the consent banner to use this feature."},!this.modal)return;let{dataset:e}=this.modal;if(e.loadingMessages)try{let t=JSON.parse(e.loadingMessages);Array.isArray(t)&&t.length>0&&(this.loadingMessages=t)}catch(e){console.warn("Could not parse loading messages dataset",e)}this.translations.invalidImage=e.errorInvalidImage||this.translations.invalidImage,this.translations.noImage=e.errorNoImage||this.translations.noImage,this.translations.sessionLimit=e.errorSessionLimit||this.translations.sessionLimit,this.translations.loadFailed=e.errorLoadFailed||this.translations.loadFailed,this.translations.generationFailed=e.errorGenerationFailed||this.translations.generationFailed,this.translations.generationException=e.errorGenerationException||this.translations.generationException,this.translations.cookieRequired=e.errorCookieRequired||this.translations.cookieRequired}_registerCookieConsentListener(){document&&document.$emitter&&"function"==typeof document.$emitter.subscribe&&document.$emitter.subscribe("CookieConfiguration_Update",this._handleCookieConfigurationUpdate.bind(this))}_handleCookieConfigurationUpdate(e){e&&Object.prototype.hasOwnProperty.call(e,h)?this.hasCookieConsent=!0===e[h]:this.hasCookieConsent=this._hasCookieConsent(),this.hasCookieConsent&&this._hideError()}_hasCookieConsent(){return!!this._getCookie(h)}_checkAutoOpenFromQuery(){if(this.modal)try{let e=new URLSearchParams(window.location.search);if("1"===e.get("openScenePreview")){this._openModal(),e.delete("openScenePreview");let t=e.toString(),s="".concat(window.location.pathname).concat(t?"?".concat(t):"").concat(window.location.hash);window.history.replaceState({},document.title,s)}}catch(e){console.warn("Failed to process openScenePreview query parameter",e)}}_canGenerate(){return!!this.isLoggedIn&&(!!this.hasCookieConsent||(this._showError(this.translations.cookieRequired),!1))}_getContextToken(){return this.contextToken||(this.modal&&this.modal.dataset&&this.modal.dataset.contextToken?this.contextToken=this.modal.dataset.contextToken:this.contextToken=this._readContextTokenCookie()),this.contextToken}_readContextTokenCookie(){let e=document.cookie.match(/(?:^|;\s*)sw-context-token=([^;]+)/i);if(!e)return null;try{return decodeURIComponent(e[1])}catch(t){return console.warn("Failed to decode context token cookie",t),e[1]}}_setContextToken(e){if(!e)return;this.contextToken=e,this.modal&&(this.modal.dataset.contextToken=e);let t=["sw-context-token="+e,"path=/","SameSite=Lax"];"https:"===window.location.protocol&&t.push("Secure"),document.cookie=t.join("; ")}_openModal(){this.productImageElement.src=this.productImageUrl,this.productImageElement.alt=this.productName,this.productNameElement.textContent=this.productName,new bootstrap.Modal(this.modal).show(),this.hasCookieConsent?this._hideError():this._showError(this.translations.cookieRequired),this.isLoggedIn&&this._updateGenerationCounter()}_onModalHidden(e){e.target===this.modal&&this._resetModal()}_resetModal(){this._resetSceneUpload(),this._hideError(),this._hideLoadingOverlay(),this._hidePlacementOrb(),this.debugData=null,this._hideDebugButton()}_resetSceneUpload(){this.sceneUpload.classList.remove("d-none"),this.scenePreview.classList.add("d-none"),this.sceneInput.value="",this.sceneImageFile=null,this._hidePlacementOrb(),this._hideLoadingOverlay()}async _handleSceneImageUpload(e){if(!e||!e.type.startsWith("image/")){this._showError(this.translations.invalidImage);return}try{let t=await this._fileToDataUrl(e);this.sceneImage.src=t,this.sceneImageFile=e,this.sceneUpload.classList.add("d-none"),this.scenePreview.classList.remove("d-none"),this._hideError()}catch(e){console.error("Failed to load image",e),this._showError(this.translations.loadFailed)}}_handleDragStart(e){this._isProductDraggable(e.target)&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setDragImage(this._createTransparentImage(),0,0))}_handleDragOver(e){this._isDropZone(e.target)&&(e.preventDefault(),e.dataTransfer.dropEffect="move")}_handleDrop(e){if(!this._isDropZone(e.target)||(e.preventDefault(),!this._canGenerate()))return;let t=this._calculateDropPosition(e);t&&this._generateComposite(t)}_handleSceneClick(e){if(!this._isDropZone(e.target)||!this._canGenerate())return;if(this.generationsRemainingCount<=0){this._showError(this.translations.sessionLimit);return}let t=this._calculateDropPosition(e);t&&this._generateComposite(t)}_handleTouchStart(e){if(!this._isProductDraggable(e.target)||!this._canGenerate())return;e.preventDefault(),this.isTouchDragging=!0;let t=e.touches[0];this.touchGhostPosition={x:t.clientX,y:t.clientY},this._showTouchGhost(),document.body.style.overflow="hidden"}_handleTouchMove(e){if(!this.isTouchDragging)return;e.preventDefault();let t=e.touches[0];this.touchGhostPosition={x:t.clientX,y:t.clientY},this._updateTouchGhost();let s=document.elementFromPoint(t.clientX,t.clientY);if(this._isDropZone(s)){let e=this.sceneDropzone.getBoundingClientRect(),s={x:t.clientX-e.left,y:t.clientY-e.top};this._showPlacementOrb(s)}else this._hidePlacementOrb()}_handleTouchEnd(e){if(!this.isTouchDragging)return;let t=e.changedTouches[0],s=document.elementFromPoint(t.clientX,t.clientY);if(this._isDropZone(s)){let e=this._calculateTouchDropPosition(t);e&&this._generateComposite(e)}this._endTouchDrag()}_endTouchDrag(){this.isTouchDragging=!1,this.touchGhostPosition=null,this._hideTouchGhost(),this._hidePlacementOrb(),document.body.style.overflow="auto"}async _generateComposite(e){if(this._canGenerate()){if(this.generationsRemainingCount<=0){this._showError(this.translations.sessionLimit);return}if(!this.sceneImageFile){this._showError(this.translations.noImage);return}try{let t;console.log("Starting generation process..."),this._showLoadingOverlay(),this._showPlacementOrb(e),this._startLoadingMessages(),console.log("Converting scene image to data URL...");let s=await this._fileToDataUrl(this.sceneImageFile);console.log("Scene data URL created, length:",s.length),console.log("Creating request data for app server...");try{let e=await fetch(this.productImageUrl),s=await e.blob();t=await this._fileToDataUrl(s)}catch(e){console.warn("Could not fetch product image, using URL:",e),t=this.productImageUrl}let o={productId:this.productId,sceneImage:s,dropPosition:{xPercent:e.xPercent,yPercent:e.yPercent},productName:this.productName,productImage:t};console.log("Request data created for app server, productId:",this.productId),console.log("Making authenticated HTTP request to:",this.options.generateUrl);let i=await this._makeAuthenticatedRequest(this.options.generateUrl,"POST",o);console.log("Promise resolved with success:",i.success),this._stopLoadingMessages(),this._hideLoadingOverlay(),this._hidePlacementOrb(),i.success?(console.log("Generation successful, updating UI..."),this.sceneImage.src=i.data.finalImage,this.generationsRemainingCount=i.sessionStatus.remaining,this._updateGenerationCounter(),this.debugMode&&i.data.debugImage&&(this.debugData={image:i.data.debugImage,prompt:i.data.prompt},this._showDebugButton()),this._hideError()):(console.log("Generation failed with error:",i.error),this._showError(i.error||this.translations.generationFailed),i.sessionStatus&&(this.generationsRemainingCount=i.sessionStatus.remaining,this._updateGenerationCounter()))}catch(e){console.error("Exception in generation process:",e),this._stopLoadingMessages(),this._hideLoadingOverlay(),this._hidePlacementOrb(),this._showError(this.translations.generationException)}}}async _checkSessionStatus(){if(this.isLoggedIn)try{console.log("Checking session status with authenticated request...");let e=await this._makeAuthenticatedRequest(this.options.sessionStatusUrl,"GET");e.success&&(this.generationsRemainingCount=e.data.remaining,this._updateGenerationCounter(),console.log("Session status updated, remaining:",e.data.remaining))}catch(e){console.warn("Could not check session status:",e)}}_calculateDropPosition(e){let t,s;let o=this.sceneDropzone.getBoundingClientRect(),i=this.sceneImage;if(!i.naturalWidth||!i.naturalHeight)return null;let n=i.naturalWidth/i.naturalHeight;n>o.width/o.height?(t=o.width,s=o.width/n):(s=o.height,t=o.height*n);let r=(o.width-t)/2,a=(o.height-s)/2,l=e.clientX-o.left,c=e.clientY-o.top,h=l-r,d=c-a;return h<0||h>t||d<0||d>s?null:{x:l,y:c,xPercent:h/t*100,yPercent:d/s*100}}_calculateTouchDropPosition(e){this.sceneDropzone.getBoundingClientRect();let t={clientX:e.clientX,clientY:e.clientY};return this._calculateDropPosition(t)}_showPlacementOrb(e){this.placementOrb.style.left=e.x+"px",this.placementOrb.style.top=e.y+"px",this.placementOrb.classList.remove("d-none")}_hidePlacementOrb(){this.placementOrb.classList.add("d-none")}_showLoadingOverlay(){this.loadingOverlay.classList.remove("d-none")}_hideLoadingOverlay(){this.loadingOverlay.classList.add("d-none")}_startLoadingMessages(){this.loadingMessage&&this.loadingMessages.length&&(this.currentLoadingMessage=0,this.loadingMessage.textContent=this.loadingMessages[0],this.loadingInterval=setInterval(()=>{this.currentLoadingMessage=(this.currentLoadingMessage+1)%this.loadingMessages.length,this.loadingMessage.textContent=this.loadingMessages[this.currentLoadingMessage]},3e3))}_stopLoadingMessages(){this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null)}_showError(e){this.errorText.textContent=e,this.errorMessage.classList.remove("d-none")}_hideError(){this.errorMessage.classList.add("d-none")}_updateGenerationCounter(){if(!this.generationsRemaining||!this.generationsAlert)return;let e=this.generationsAlert,t=this.generationsMessage,s=this.generationsCounter;if(e.classList.remove("d-none","alert-warning","alert-info"),s&&s.classList.remove("d-none"),this.generationsRemainingCount>=5){e.classList.add("d-none"),s&&s.classList.add("d-none"),t&&(t.textContent="");return}let o=Math.max(0,parseInt(this.generationsRemainingCount,10)||0);if(this.generationsRemaining.textContent=o,o<=0){if(e.classList.add("alert-warning"),t){let s=e.dataset.templateNone||"";t.textContent=s}s&&s.classList.remove("d-none");return}if(e.classList.add("alert-info"),t){let s=e.dataset.templateLow||"";t.textContent=s.replace("%count%",o)}}_showDebugButton(){this.debugButton&&this.debugButton.classList.remove("d-none")}_hideDebugButton(){this.debugButton&&this.debugButton.classList.add("d-none")}_showDebugModal(){this.debugData&&(this.debugImage.src=this.debugData.image,this.debugPrompt.textContent=this.debugData.prompt,new bootstrap.Modal(this.debugModal).show())}_showTouchGhost(){this.touchGhost.querySelector(".touch-ghost-image").src=this.productImageUrl,this.touchGhost.classList.remove("d-none"),this._updateTouchGhost()}_hideTouchGhost(){this.touchGhost.classList.add("d-none")}_updateTouchGhost(){this.touchGhostPosition&&(this.touchGhost.style.left=this.touchGhostPosition.x-25+"px",this.touchGhost.style.top=this.touchGhostPosition.y-25+"px")}_isProductDraggable(e){return null!==e.closest(this.options.productDisplaySelector)}_isDropZone(e){return e&&(e.matches(this.options.sceneDropzoneSelector)||null!==e.closest(this.options.sceneDropzoneSelector))}_fileToDataUrl(e){return new Promise((t,s)=>{let o=new FileReader;o.onload=()=>t(o.result),o.onerror=s,o.readAsDataURL(e)})}_createTransparentImage(){let e=new Image;return e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",e}_getCookie(e){let t="; ".concat(document.cookie).split("; ".concat(e,"="));return 2===t.length?t.pop().split(";").shift():null}async _ensureContextToken(){let e=this._getCookie("sw-context-token");if(e)return e;try{e=await new Promise(e=>{let t=new XMLHttpRequest;t.open("GET","/store-api/context"),this.accessKey&&t.setRequestHeader("sw-access-key",this.accessKey),t.addEventListener("loadend",()=>{let s=t.getResponseHeader("sw-context-token");s?(this._setContextToken(s),e(s)):e(null)}),t.send()})}catch(e){}return e}async _makeAuthenticatedRequest(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"GET",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(!this.isLoggedIn)throw Error("Login required");await this._ensureContextToken();let i={headers:{Accept:"application/json"}};"GET"!==t&&null!==s&&(i.headers["Content-Type"]="application/json",i.body=JSON.stringify(s));try{let n;switch(t){case"GET":n=await this.appClient.get(e,i);break;case"POST":n=await this.appClient.post(e,i);break;case"PATCH":n=await this.appClient.patch(e,i);break;case"DELETE":n=await this.appClient.delete(e,i);break;default:throw Error("Unsupported request method: ".concat(t))}let r=await n.text(),a=r?JSON.parse(r):null;if(n.ok)return a;if(401===n.status&&0===o)return this.appClient.reset(),this._makeAuthenticatedRequest(e,t,s,o+1);let l=a&&a.error||"HTTP ".concat(n.status," error");throw Error(l)}catch(i){if(0===o&&i instanceof SyntaxError)return this.appClient.reset(),this._makeAuthenticatedRequest(e,t,s,o+1);throw i}}}d.options={generateUrl:"".concat(c,"/api/ai-scene/generate"),sessionStatusUrl:"".concat(c,"/api/ai-scene/session-status"),modalSelector:"[data-ai-scene-preview-modal]",debugModalSelector:"[data-ai-scene-debug-modal]",sceneUploadSelector:"[data-scene-upload]",scenePreviewSelector:"[data-scene-preview]",sceneInputSelector:"[data-scene-input]",sceneImageSelector:"[data-scene-image]",sceneDropzoneSelector:"[data-scene-dropzone]",productDisplaySelector:"[data-product-display]",productImageSelector:"[data-product-image]",productNameSelector:"[data-product-name]",placementOrbSelector:"[data-placement-orb]",loadingOverlaySelector:"[data-loading-overlay]",loadingMessageSelector:"[data-loading-message]",errorMessageSelector:"[data-error-message]",errorTextSelector:"[data-error-text]",generationsCounterSelector:"[data-generations-counter]",generationsAlertSelector:"[data-generations-alert]",generationsRemainingSelector:"[data-generations-remaining]",generationsMessageSelector:"[data-generations-message]",changeSceneSelector:"[data-change-scene]",debugButtonSelector:"[data-debug-button]",touchGhostSelector:"[data-touch-ghost]",debugImageSelector:"[data-debug-image]",debugPromptSelector:"[data-debug-prompt]"},window.PluginManager.register("AiScenePreview",d,"[data-ai-scene-preview-trigger]")})()})();