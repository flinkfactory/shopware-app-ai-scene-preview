{% sw_extends '@Storefront/storefront/block/cms-block-gallery-buybox.html.twig' %}

{% block block_gallery_buybox_column_left_inner %}
    {{ parent() }}

    {# Check if feature is enabled globally and for this product #}
    {% set isEnabled = config('FlinkAiScenePreviewApp.config.enabled') and page.product.customFields.flink_ai_scene_preview_enabled|default(false) %}
    
    {% if isEnabled %}
        {# Resolve product image from custom field if available #}
        {% set productImage = null %}
        {% if page.product.customFields.flink_ai_scene_preview_image %}
            {% set mediaIds = [page.product.customFields.flink_ai_scene_preview_image] %}
            {% set mediaCollection = searchMedia(mediaIds, context.context) %}
            {% set productMedia = mediaCollection.get(page.product.customFields.flink_ai_scene_preview_image) %}
            {% if productMedia %}
                {% set productImage = productMedia.url %}
            {% endif %}
        {% endif %}
        
        {# Fall back to product cover if no custom image #}
        {% if not productImage and page.product.cover and page.product.cover.media %}
            {% set productImage = page.product.cover.media.url %}
        {% endif %}
        
        {% set options = {
            'productId': page.product.id,
            'productName': page.product.translated.name|default('Product'),
            'productImage': productImage,
            'maxGenerations': config('FlinkAiScenePreviewApp.config.maxGenerationsPerSession'),
            'debugMode': config('FlinkAiScenePreviewApp.config.debugMode'),
        } %}
        <div class="ai-scene-preview-button-wrapper mt-3">
            <button type="button"
                    class="btn btn-primary btn-block ai-scene-preview-button"
                    data-ai-scene-preview-trigger="true"
                    data-ai-scene-preview-options='{{ options|json_encode }}'>
                {% sw_icon 'eye-open' style { size: 'xs'} %}
                {{ "ai-scene-preview.button.previewInRoom"|trans }}
            </button>
        </div>

        {% sw_include '@FlinkAiScenePreview/storefront/component/ai-scene-preview-modal.html.twig' %}
    {% endif %}
{% endblock %}